<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stats – Science Bowl Bot</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #0d1b2a;
      --surface: #1b263b91;
      --surface2: #162535;
      --border: #415a7793;
      --accent: #778da9;
      --accent2: #4e8098;
      --text: #e8f0fe;
      --muted: #e0e1dd;
      --green: #00ff88;
      --red: #ff4d6d;
      --yellow: #ffd60a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'IBM Plex Sans', sans-serif;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.4; z-index: 0; pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed; top: -50%; left: -50%;
      width: 200%; height: 200%;
      background:
        radial-gradient(ellipse at 60% 40%, rgba(34,131,110,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 30% 70%, rgba(194,113,37,0.10) 0%, transparent 60%);
      z-index: 0; pointer-events: none;
    }

    .container {
      position: relative; z-index: 1;
      max-width: 860px; margin: 0 auto;
      padding: 36px 24px 80px;
    }

    /* Top nav */
    .topnav {
      display: flex; align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
    }

    .back-btn {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px; letter-spacing: 2px;
      color: var(--muted); text-decoration: none;
      text-transform: uppercase;
      border: 1px solid var(--border);
      padding: 6px 14px; border-radius: 2px;
      transition: color 0.2s, border-color 0.2s;
    }
    .back-btn:hover { color: var(--accent); border-color: var(--accent); }

    .page-title {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 42px; letter-spacing: 3px;
      color: var(--text);
    }

    .clear-btn {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px; letter-spacing: 2px;
      text-transform: uppercase;
      background: none; border: 1px solid var(--border);
      color: var(--muted); padding: 6px 14px;
      border-radius: 2px; cursor: pointer;
      transition: all 0.2s;
    }
    .clear-btn:hover { border-color: var(--red); color: var(--red); }

    /* Section headers */
    .section-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px; letter-spacing: 3px;
      text-transform: uppercase; color: var(--muted);
      margin-bottom: 14px; margin-top: 40px;
    }

    /* Big stat cards */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px; margin-bottom: 8px;
    }
    @media (max-width: 600px) { .stat-grid { grid-template-columns: repeat(2, 1fr); } }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px; padding: 20px 16px;
      text-align: center;
    }
    .stat-card .val {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 44px; line-height: 1;
      color: var(--accent); display: block;
    }
    .stat-card .val.green { color: var(--green); }
    .stat-card .val.yellow { color: var(--yellow); }
    .stat-card .lbl {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px; letter-spacing: 2px;
      text-transform: uppercase; color: var(--muted);
      margin-top: 4px;
    }

    /* Subject accuracy table */
    .subject-table {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px; overflow: hidden;
    }

    .subject-row {
      display: grid;
      grid-template-columns: 1fr 80px 80px 120px;
      align-items: center;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
    }
    .subject-row:last-child { border-bottom: none; }
    .subject-row.header {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px; letter-spacing: 2px;
      text-transform: uppercase; color: var(--muted);
      background: rgba(0,0,0,0.2);
    }

    .subject-name {
      font-family: 'IBM Plex Sans', monospace;
      font-size: 13px; color: var(--text);
    }
    .subject-num {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px; color: var(--muted);
      text-align: center;
    }
    .subject-pct {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 20px; text-align: center;
    }

    /* Bar */
    .bar-wrap { position: relative; height: 6px; background: var(--border); border-radius: 3px; }
    .bar-fill  { height: 100%; border-radius: 3px; background: var(--accent); transition: width 0.6s ease; }
    .bar-fill.good  { background: var(--green); }
    .bar-fill.mid   { background: var(--yellow); }
    .bar-fill.bad   { background: var(--red); }

    /* Versus record */
    .record-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .record-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px; padding: 20px;
      text-align: center;
    }
    .record-card .diff-label {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 22px; letter-spacing: 2px;
      color: var(--accent2); margin-bottom: 8px;
    }
    .record-card .wl {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px; color: var(--muted);
    }
    .record-card .wl span { color: var(--text); font-weight: 600; }

    /* Recent matches */
    .match-list {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px; overflow: hidden;
    }
    .match-row {
      display: flex; align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
    }
    .match-row:last-child { border-bottom: none; }
    .match-date { color: var(--muted); font-size: 11px; }
    .match-score { color: var(--text); }
    .match-diff { color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-size: 10px; }
    .match-result { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 1px; }
    .match-result.win  { color: var(--green); }
    .match-result.loss { color: var(--red); }
    .match-result.tie  { color: var(--yellow); }

    /* Empty state */
    .empty {
      text-align: center; padding: 40px 20px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px; color: var(--muted);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
    }
    .empty a { color: var(--accent); text-decoration: none; }
    .empty a:hover { text-decoration: underline; }

    /* Streak highlight */
    .streak-banner {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--green);
      border-radius: 4px; padding: 16px 20px;
      display: flex; align-items: center;
      justify-content: space-between;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px; color: var(--muted);
      margin-bottom: 8px;
    }
    .streak-banner .streak-val {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 32px; color: var(--green);
      line-height: 1;
    }
  </style>
</head>
<body>
<div class="container">

  <div class="topnav">
    <a href="index.html" class="back-btn">← HOME</a>
    <div class="page-title">MY STATS</div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="account-badge" style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px;"></div>
      <button class="clear-btn" onclick="clearStats()">RESET DATA</button>
    </div>
  </div>

  <!-- ── PRACTICE STATS ── -->
  <div class="section-label">Practice — Overall</div>
  <div class="stat-grid" id="practice-overall">
    <div class="stat-card"><span class="val" id="p-total">0</span><span class="lbl">Questions</span></div>
    <div class="stat-card"><span class="val green" id="p-correct">0</span><span class="lbl">Correct</span></div>
    <div class="stat-card"><span class="val" id="p-pct">—</span><span class="lbl">Accuracy</span></div>
    <div class="stat-card"><span class="val yellow" id="p-points">0</span><span class="lbl">Total Points</span></div>
  </div>

  <div id="streak-wrap" style="display:none">
    <div class="section-label">Current Streak</div>
    <div class="streak-banner">
      <span>Correct answers in a row</span>
      <span class="streak-val" id="p-streak">0</span>
    </div>
  </div>

  <div class="section-label">Accuracy by Subject</div>
  <div id="subject-wrap">
    <div class="empty">No practice data yet. <a href="practice.html">Start practicing →</a></div>
  </div>

  <!-- ── VERSUS STATS ── -->
  <div class="section-label">Vs. Bot — Record</div>
  <div class="stat-grid" style="grid-template-columns: repeat(3,1fr); margin-bottom:16px">
    <div class="stat-card"><span class="val green" id="v-wins">0</span><span class="lbl">Wins</span></div>
    <div class="stat-card"><span class="val" style="color:var(--red)" id="v-losses">0</span><span class="lbl">Losses</span></div>
    <div class="stat-card"><span class="val yellow" id="v-ties">0</span><span class="lbl">Ties</span></div>
  </div>

  <div class="section-label">By Difficulty</div>
  <div class="record-grid" id="diff-wrap">
    <div class="empty" style="grid-column:1/-1">No matches played yet. <a href="versus.html">Play now →</a></div>
  </div>

  <div class="section-label">Recent Matches</div>
  <div id="recent-wrap">
    <div class="empty">No matches played yet. <a href="versus.html">Play now →</a></div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="stats.js"></script>
<script>
function render() {
  // Show account status
  setTimeout(() => {
    const user = Stats.getUser();
    const badge = document.getElementById('account-badge');
    if (badge) {
      if (user) {
        badge.innerHTML = `<span style="color:var(--green)">● </span>${user.email} · <a href="#" onclick="handleSignOut()" style="color:var(--muted);text-decoration:none;">sign out</a>`;
      } else {
        badge.innerHTML = `<a href="auth.html" style="color:var(--accent);text-decoration:none;">Sign in to sync →</a>`;
      }
    }
  }, 300);
  const ps = Stats.getPracticeStats();
  const vs = Stats.getVersusStats();

  // ── Practice overall ──
  document.getElementById('p-total').textContent   = ps.total;
  document.getElementById('p-correct').textContent = ps.correct;
  document.getElementById('p-pct').textContent     = ps.total > 0 ? Math.round(ps.correct / ps.total * 100) + '%' : '—';
  document.getElementById('p-points').textContent  = ps.points;

  // Streak
  if (ps.streak > 1) {
    document.getElementById('streak-wrap').style.display = 'block';
    document.getElementById('p-streak').textContent = ps.streak;
  }

  // ── Subject accuracy ──
  const subjectWrap = document.getElementById('subject-wrap');
  const subjects = Object.keys(ps.bySubject);
  if (subjects.length > 0) {
    // Sort by most answered
    subjects.sort((a, b) => ps.bySubject[b].total - ps.bySubject[a].total);

    subjectWrap.innerHTML = `
      <div class="subject-table">
        <div class="subject-row header">
          <span>Subject</span>
          <span style="text-align:center">Answered</span>
          <span style="text-align:center">Accuracy</span>
          <span></span>
        </div>
        ${subjects.map(s => {
          const d = ps.bySubject[s];
          const barClass = d.pct >= 70 ? 'good' : d.pct >= 40 ? 'mid' : 'bad';
          const pctColor = d.pct >= 70 ? 'var(--green)' : d.pct >= 40 ? 'var(--yellow)' : 'var(--red)';
          return `
          <div class="subject-row">
            <span class="subject-name">${s}</span>
            <span class="subject-num">${d.total}</span>
            <span class="subject-pct" style="color:${pctColor}">${d.pct}%</span>
            <div class="bar-wrap">
              <div class="bar-fill ${barClass}" style="width:${d.pct}%"></div>
            </div>
          </div>`;
        }).join('')}
      </div>`;
  }

  // ── Versus overall ──
  document.getElementById('v-wins').textContent   = vs.wins;
  document.getElementById('v-losses').textContent = vs.losses;
  document.getElementById('v-ties').textContent   = vs.ties;

  // ── By difficulty ──
  const diffWrap = document.getElementById('diff-wrap');
  if (Object.keys(vs.byDiff).length > 0) {
    diffWrap.innerHTML = ['novice','varsity','elite'].map(d => {
      if (!vs.byDiff[d]) return `
        <div class="record-card">
          <div class="diff-label">${d}</div>
          <div class="wl">No matches yet</div>
        </div>`;
      const { played, wins } = vs.byDiff[d];
      const losses = played - wins;
      return `
        <div class="record-card">
          <div class="diff-label">${d}</div>
          <div class="wl"><span>${wins}W</span> – <span>${losses}L</span></div>
          <div class="wl" style="margin-top:4px">${played} played · ${Math.round(wins/played*100)}% win rate</div>
        </div>`;
    }).join('');
  }

  // ── Recent matches ──
  const recentWrap = document.getElementById('recent-wrap');
  if (vs.recent.length > 0) {
    recentWrap.innerHTML = `<div class="match-list">` +
      vs.recent.map(m => {
        const date = new Date(m.date).toLocaleDateString('en-US', { month:'short', day:'numeric' });
        const resultText = m.youScore > m.botScore ? 'WIN' : m.youScore < m.botScore ? 'LOSS' : 'TIE';
        const resultClass = m.youScore > m.botScore ? 'win' : m.youScore < m.botScore ? 'loss' : 'tie';
        return `
          <div class="match-row">
            <span class="match-date">${date}</span>
            <span class="match-diff">${m.difficulty} · ${m.length}</span>
            <span class="match-score">${m.youScore} – ${m.botScore}</span>
            <span class="match-result ${resultClass}">${resultText}</span>
          </div>`;
      }).join('') + `</div>`;
  }
}

async function handleSignOut() {
  await Stats.signOut();
  location.reload();
}

function clearStats() {
  if (confirm('Reset all stats? This cannot be undone.')) {
    Stats.clearAll();
    location.reload();
  }
}

render();
</script>
</body>
</html>
